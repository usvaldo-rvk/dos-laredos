generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Rol {
  OPERARIO
  SUPERVISOR
  ADMIN
}

enum EstadoTarima {
  ACTIVA
  RESERVADA
  AGOTADA
  BLOQUEADA
}

enum TipoEvento {
  CREACION
  RECEPCION
  ENTRADA
  SALIDA
  ASIGNACION_PICK
  PICK
  MERMA
  REUBICACION
  AJUSTE
  AJUSTE_POSITIVO
  AJUSTE_NEGATIVO
  CIERRE_TARIMA
}

enum EstadoPedido {
  CREADO            // Pedido capturado, sin asignación de tarimas
  ENVIADO_BODEGA    // Tarimas asignadas, inventario descontado, enviado a bodega
  EN_REVISION       // Bodega reportó problema (falta producto, etc.)
  COMPLETADO        // Entregado/finalizado (opcional, para histórico)
  CANCELADO         // Cancelado
}

enum EstadoAsignacion {
  ABIERTA
  CONFIRMADA
  CANCELADA
}

enum TipoCliente {
  PERSONA
  EMPRESA
}

enum TipoUbicacion {
  PASILLO
  FILA
  ZONA
}

enum TipoEnvase {
  LATA
  BOTELLA
  OTRO
}

// Métodos de pago
enum MetodoPago {
  EFECTIVO
  TRANSFERENCIA
  TARJETA
  CREDITO
}

// Estado de pago del pedido
enum EstadoPago {
  PENDIENTE       // Sin pagos registrados
  PARCIAL         // Pagado parcialmente
  PAGADO          // Totalmente pagado
  CREDITO         // Todo o parte a crédito
}

// Estado del crédito
enum EstadoCredito {
  PENDIENTE
  PARCIAL
  PAGADO
}

enum TipoEntrega {
  RECOLECCION   // Cliente recoge en almacén
  ENVIO         // Se envía a domicilio
}

// ============================================================================
// CATALOGOS BASE
// ============================================================================

model Almacen {
  id        String   @id @default(cuid())
  codigo    String   @unique // LP, LM
  nombre    String   // Laredo Poniente, Laredo México
  direccion String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  ubicaciones   Ubicacion[]
  tarimas       Tarima[]
  eventos       EventoTarima[]
  pedidos       Pedido[]
  usuarios      UsuarioAlmacen[]
  pantallasTv   PantallaTv[]
  umbralesStock UmbralStock[]

  @@map("almacenes")
}

model Ubicacion {
  id          String        @id @default(cuid())
  almacenId   String        @map("almacen_id")
  codigo      String        // P1-F3
  tipo        TipoUbicacion
  descripcion String?
  activo      Boolean       @default(true)
  createdAt   DateTime      @default(now()) @map("created_at")

  // Relaciones
  almacen         Almacen        @relation(fields: [almacenId], references: [id])
  tarimas         Tarima[]
  eventosOrigen   EventoTarima[] @relation("UbicacionOrigen")
  eventosDestino  EventoTarima[] @relation("UbicacionDestino")

  @@unique([almacenId, codigo])
  @@map("ubicaciones")
}

model Producto {
  id                String      @id @default(cuid())
  sku               String      @unique
  nombre            String
  descripcion       String?
  presentacion      String      // Caja, Bolsa, etc.
  unidadMedida      String      @map("unidad_medida") // Tapas, Piezas, Cartones

  // Campos de envase y retornabilidad
  tipoEnvase        TipoEnvase? @map("tipo_envase")
  capacidadMl       Int?        @map("capacidad_ml") // 355, 600, 1000, etc.
  unidadesPorCarton Int?        @map("unidades_por_carton") // 6, 12, 24
  esRetornable      Boolean     @default(false) @map("es_retornable")

  // Precio de venta al público
  precioPublico     Decimal?    @map("precio_publico") @db.Decimal(10, 2)

  activo            Boolean     @default(true)
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relaciones
  tarimas            Tarima[]
  pedidoLineas       PedidoLinea[]
  umbralesStock      UmbralStock[]
  productosProveedor ProductoProveedor[]

  @@map("productos")
}

model Proveedor {
  id        String   @id @default(cuid())
  codigo    String   @unique
  nombre    String
  contacto  String?
  telefono  String?
  email     String?
  rfc       String?  // RFC para facturación
  direccion String?  // Dirección completa
  notas     String?  // Notas adicionales
  activo    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  tarimas            Tarima[]
  productosProveedor ProductoProveedor[]

  @@map("proveedores")
}

// Relación Producto-Proveedor con precios
model ProductoProveedor {
  id            String   @id @default(cuid())
  productoId    String   @map("producto_id")
  proveedorId   String   @map("proveedor_id")
  precioCompra  Decimal  @map("precio_compra") @db.Decimal(10, 2) // Precio al que nos vende
  valorDeposito Decimal? @map("valor_deposito") @db.Decimal(10, 2) // Depósito por envase retornable
  activo        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  producto  Producto  @relation(fields: [productoId], references: [id], onDelete: Cascade)
  proveedor Proveedor @relation(fields: [proveedorId], references: [id], onDelete: Cascade)

  @@unique([productoId, proveedorId])
  @@map("productos_proveedores")
}

// ============================================================================
// CLIENTES
// ============================================================================

model Cliente {
  id                 String      @id @default(cuid())
  tipo               TipoCliente
  nombreEmpresa      String?     @map("nombre_empresa")
  nombreContacto     String      @map("nombre_contacto")
  telefono           String
  telefonoSecundario String?     @map("telefono_secundario")
  email              String?
  rfc                String?     // RFC para facturación
  direccionCalle     String?     @map("direccion_calle")
  direccionNumero    String?     @map("direccion_numero")
  direccionColonia   String?     @map("direccion_colonia")
  direccionCiudad    String?     @map("direccion_ciudad")
  direccionEstado    String?     @map("direccion_estado")
  direccionCp        String?     @map("direccion_cp")
  coordenadasLat     Float?      @map("coordenadas_lat")
  coordenadasLng     Float?      @map("coordenadas_lng")
  notas              String?
  activo             Boolean     @default(true)
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  // Relaciones
  pedidos  Pedido[]
  creditos Credito[]

  @@map("clientes")
}

// ============================================================================
// USUARIOS Y AUTENTICACION
// ============================================================================

model Usuario {
  id           String   @id @default(cuid())
  nombre       String
  email        String   @unique
  passwordHash String   @map("password_hash")
  pinHash      String?  @map("pin_hash")
  rol          Rol
  activo       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relaciones
  almacenes               UsuarioAlmacen[]
  eventos                 EventoTarima[]            @relation("EventoUsuario")
  eventosSupervisados     EventoTarima[]            @relation("EventoSupervisor")
  pedidosCreados          Pedido[]
  passwordResetTokens     PasswordResetToken[]
  preferenciasNotificacion PreferenciaNotificacion[]
  notificaciones          Notificacion[]
  pagosRegistrados        Pago[]
  abonosRegistrados       Abono[]

  @@map("usuarios")
}

model UsuarioAlmacen {
  id        String   @id @default(cuid())
  usuarioId String   @map("usuario_id")
  almacenId String   @map("almacen_id")
  createdAt DateTime @default(now()) @map("created_at")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  almacen Almacen @relation(fields: [almacenId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, almacenId])
  @@map("usuarios_almacenes")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  usuarioId String    @map("usuario_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

// ============================================================================
// NOTIFICACIONES
// ============================================================================

model TipoNotificacion {
  id          String @id @default(cuid())
  codigo      String @unique // STOCK_CERO, STOCK_BAJO, etc.
  nombre      String
  descripcion String?

  preferencias   PreferenciaNotificacion[]
  notificaciones Notificacion[]

  @@map("tipos_notificacion")
}

model PreferenciaNotificacion {
  id                 String  @id @default(cuid())
  usuarioId          String  @map("usuario_id")
  tipoNotificacionId String  @map("tipo_notificacion_id")
  emailHabilitado    Boolean @default(true) @map("email_habilitado")
  pushHabilitado     Boolean @default(false) @map("push_habilitado")

  usuario          Usuario          @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  tipoNotificacion TipoNotificacion @relation(fields: [tipoNotificacionId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, tipoNotificacionId])
  @@map("preferencias_notificacion")
}

model Notificacion {
  id                 String   @id @default(cuid())
  usuarioId          String   @map("usuario_id")
  tipoNotificacionId String   @map("tipo_notificacion_id")
  titulo             String
  mensaje            String
  leida              Boolean  @default(false)
  createdAt          DateTime @default(now()) @map("created_at")

  usuario          Usuario          @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  tipoNotificacion TipoNotificacion @relation(fields: [tipoNotificacionId], references: [id], onDelete: Cascade)

  @@map("notificaciones")
}

// ============================================================================
// INVENTARIO - TARIMAS Y EVENTOS
// ============================================================================

model Tarima {
  id               String        @id @default(cuid())
  almacenId        String        @map("almacen_id")
  productoId       String        @map("producto_id")
  proveedorId      String        @map("proveedor_id")
  ubicacionId      String?       @map("ubicacion_id")
  capacidadTotal   Int           @map("capacidad_total")
  precioUnitario   Decimal?      @map("precio_unitario") @db.Decimal(10, 2)    // Precio de compra por unidad (cartón/tapa)
  depositoPorEnvase Decimal?     @map("deposito_por_envase") @db.Decimal(10, 2) // Depósito por cada envase retornable
  lote             String?
  fechaProduccion  DateTime?     @map("fecha_produccion")
  fechaCaducidad   DateTime?     @map("fecha_caducidad")
  estado           EstadoTarima  @default(ACTIVA)
  qrCode           String        @unique @map("qr_code")
  fechaIngreso     DateTime      @default(now()) @map("fecha_ingreso")
  createdAt        DateTime      @default(now()) @map("created_at")

  // Relaciones
  almacen      Almacen          @relation(fields: [almacenId], references: [id])
  producto     Producto         @relation(fields: [productoId], references: [id])
  proveedor    Proveedor        @relation(fields: [proveedorId], references: [id])
  ubicacion    Ubicacion?       @relation(fields: [ubicacionId], references: [id])
  eventos      EventoTarima[]
  asignaciones AsignacionPick[]

  @@index([almacenId, estado])
  @@index([productoId])
  @@index([qrCode])
  @@map("tarimas")
}

model EventoTarima {
  id                 String     @id @default(cuid())
  tarimaId           String     @map("tarima_id")
  almacenId          String     @map("almacen_id")
  tipo               TipoEvento
  usuarioId          String     @map("usuario_id")
  rolUsuario         Rol        @map("rol_usuario")
  supervisorId       String?    @map("supervisor_id")
  cantidad           Int?
  pedidoId           String?    @map("pedido_id")
  ubicacionOrigenId  String?    @map("ubicacion_origen_id")
  ubicacionDestinoId String?    @map("ubicacion_destino_id")
  motivo             String?
  timestampLocal     DateTime   @map("timestamp_local")
  timestampServidor  DateTime   @default(now()) @map("timestamp_servidor")
  syncBatchId        String?    @map("sync_batch_id")
  createdAt          DateTime   @default(now()) @map("created_at")

  // Relaciones
  tarima          Tarima     @relation(fields: [tarimaId], references: [id])
  almacen         Almacen    @relation(fields: [almacenId], references: [id])
  usuario         Usuario    @relation("EventoUsuario", fields: [usuarioId], references: [id])
  supervisor      Usuario?   @relation("EventoSupervisor", fields: [supervisorId], references: [id])
  pedido          Pedido?    @relation(fields: [pedidoId], references: [id])
  ubicacionOrigen Ubicacion? @relation("UbicacionOrigen", fields: [ubicacionOrigenId], references: [id])
  ubicacionDestino Ubicacion? @relation("UbicacionDestino", fields: [ubicacionDestinoId], references: [id])

  @@index([tarimaId])
  @@index([almacenId, timestampLocal])
  @@index([tipo])
  @@map("eventos_tarima")
}

// ============================================================================
// PEDIDOS Y PICKING
// ============================================================================

model Pedido {
  id             String       @id @default(cuid())
  almacenId      String       @map("almacen_id")
  clienteId      String       @map("cliente_id")
  numeroPedido   String       @unique @map("numero_pedido")
  estado         EstadoPedido @default(CREADO)
  notas          String?
  fechaRequerida DateTime?    @map("fecha_requerida")
  creadoPor      String       @map("creado_por")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Tipo de entrega
  tipoEntrega        TipoEntrega @default(RECOLECCION) @map("tipo_entrega")
  direccionCalle     String?     @map("direccion_calle")
  direccionNumero    String?     @map("direccion_numero")
  direccionColonia   String?     @map("direccion_colonia")
  direccionCiudad    String?     @map("direccion_ciudad")
  direccionEstado    String?     @map("direccion_estado")
  direccionCp        String?     @map("direccion_cp")
  direccionReferencia String?    @map("direccion_referencia")  // Referencias para encontrar el lugar

  // Campos de pago
  subtotal       Decimal?     @db.Decimal(10, 2)
  descuento      Decimal?     @default(0) @db.Decimal(10, 2)
  total          Decimal?     @db.Decimal(10, 2)
  estadoPago     EstadoPago   @default(PENDIENTE) @map("estado_pago")

  // Relaciones
  almacen      Almacen        @relation(fields: [almacenId], references: [id])
  cliente      Cliente        @relation(fields: [clienteId], references: [id])
  creadoPorRef Usuario        @relation(fields: [creadoPor], references: [id])
  lineas       PedidoLinea[]
  eventos      EventoTarima[]
  pagos        Pago[]
  creditos     Credito[]

  @@index([almacenId, estado])
  @@index([clienteId])
  @@map("pedidos")
}

model PedidoLinea {
  id                 String   @id @default(cuid())
  pedidoId           String   @map("pedido_id")
  productoId         String   @map("producto_id")
  cantidadSolicitada Int      @map("cantidad_solicitada")
  cantidadSurtida    Int      @default(0) @map("cantidad_surtida")

  // Precios al momento de la venta (historial)
  precioUnitario     Decimal? @map("precio_unitario") @db.Decimal(10, 2)  // Precio al público
  costoUnitario      Decimal? @map("costo_unitario") @db.Decimal(10, 2)   // Costo del proveedor
  subtotal           Decimal? @db.Decimal(10, 2)                          // Total de la línea (precio * cantidad)

  // Información del proveedor (snapshot al momento de la venta)
  proveedorId        String?  @map("proveedor_id")                        // ID del proveedor que suministró
  proveedorNombre    String?  @map("proveedor_nombre")                    // Nombre del proveedor (snapshot)

  createdAt          DateTime @default(now()) @map("created_at")

  // Relaciones
  pedido       Pedido           @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  producto     Producto         @relation(fields: [productoId], references: [id])
  asignaciones AsignacionPick[]

  @@map("pedido_lineas")
}

model AsignacionPick {
  id                  String           @id @default(cuid())
  pedidoLineaId       String           @map("pedido_linea_id")
  tarimaId            String           @map("tarima_id")
  cantidadAsignada    Int              @map("cantidad_asignada")
  cantidadConfirmada  Int              @default(0) @map("cantidad_confirmada")
  estado              EstadoAsignacion @default(ABIERTA)
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")

  // Relaciones
  pedidoLinea PedidoLinea @relation(fields: [pedidoLineaId], references: [id], onDelete: Cascade)
  tarima      Tarima      @relation(fields: [tarimaId], references: [id])

  @@index([tarimaId, estado])
  @@map("asignaciones_pick")
}

// ============================================================================
// CONFIGURACION
// ============================================================================

model ConfiguracionSistema {
  id          String @id @default(cuid())
  clave       String @unique
  valor       String
  descripcion String?

  @@map("configuracion_sistema")
}

model UmbralStock {
  id              String @id @default(cuid())
  productoId      String @map("producto_id")
  almacenId       String @map("almacen_id")
  cantidadMinima  Int    @map("cantidad_minima")
  cantidadCritica Int    @map("cantidad_critica")

  producto Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  almacen  Almacen  @relation(fields: [almacenId], references: [id], onDelete: Cascade)

  @@unique([productoId, almacenId])
  @@map("umbrales_stock")
}

model PantallaTv {
  id        String   @id @default(cuid())
  almacenId String   @map("almacen_id")
  token     String   @unique
  nombre    String
  activa    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")

  almacen Almacen @relation(fields: [almacenId], references: [id], onDelete: Cascade)

  @@map("pantallas_tv")
}

// ============================================================================
// PAGOS Y CRÉDITOS
// ============================================================================

// Pagos realizados en un pedido
model Pago {
  id              String     @id @default(cuid())
  pedidoId        String     @map("pedido_id")
  metodoPago      MetodoPago @map("metodo_pago")
  monto           Decimal    @db.Decimal(10, 2)
  referencia      String?    // Número de transferencia, últimos 4 dígitos tarjeta, etc.
  comprobante     String?    // URL/path de imagen del comprobante
  notas           String?
  registradoPor   String     @map("registrado_por")
  createdAt       DateTime   @default(now()) @map("created_at")

  pedido           Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  registradoPorRef Usuario @relation(fields: [registradoPor], references: [id])

  @@index([pedidoId])
  @@index([metodoPago])
  @@map("pagos")
}

// Créditos pendientes de clientes
model Credito {
  id               String        @id @default(cuid())
  clienteId        String        @map("cliente_id")
  pedidoId         String        @map("pedido_id")
  montoOriginal    Decimal       @map("monto_original") @db.Decimal(10, 2)
  montoPendiente   Decimal       @map("monto_pendiente") @db.Decimal(10, 2)
  estado           EstadoCredito @default(PENDIENTE)
  fechaVencimiento DateTime?     @map("fecha_vencimiento")
  notas            String?
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  cliente Cliente @relation(fields: [clienteId], references: [id])
  pedido  Pedido  @relation(fields: [pedidoId], references: [id])
  abonos  Abono[]

  @@index([clienteId])
  @@index([estado])
  @@map("creditos")
}

// Abonos a créditos
model Abono {
  id            String     @id @default(cuid())
  creditoId     String     @map("credito_id")
  metodoPago    MetodoPago @map("metodo_pago")
  monto         Decimal    @db.Decimal(10, 2)
  referencia    String?    // Número de transferencia, etc.
  comprobante   String?    // URL/path de imagen del comprobante
  registradoPor String     @map("registrado_por")
  createdAt     DateTime   @default(now()) @map("created_at")

  credito          Credito @relation(fields: [creditoId], references: [id], onDelete: Cascade)
  registradoPorRef Usuario @relation(fields: [registradoPor], references: [id])

  @@index([creditoId])
  @@map("abonos")
}
